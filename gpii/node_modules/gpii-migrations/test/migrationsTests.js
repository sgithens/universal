/**
 GPII Migrations Tests

 Copyright 2016-2017 OCAD University

 Licensed under the New BSD license. You may not use this file except in
 compliance with this License.

 You may obtain a copy of the License at
 https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii  = fluid.registerNamespace("gpii");


fluid.require("%gpii-universal");
gpii.loadTestingSupport();

require("gpii-migrations");

/**
 * Test sequence:
 * Run mangoQuery for original number of items, verify correct.
 * Run mangoQuery for total number of documents, verify correct.
 * Run the migration.
 * Re-run both mangoQueries and verify number of items.
 * Check one of the migrated safes and verify it's structure
 */
fluid.defaults("gpii.tests.migrations.simpleDocumentMigrationTest", {
    gradeNames: ["gpii.tests.migrations.environment"],
    components: {
        caseHolder: {
            options: {
                modules: [{
                    name: "Simple Document Migration: Single Document at a Time",
                    tests: [
                        {
                            name: "Number of items to migrate",
                            sequenceGrade: "gpii.tests.migrations.sequenceGrade",
                            sequence: [{
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["5 items to migrate", 5, "{arguments}.0.docs.length"]
                            }, {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "fluid.promise.fireTransformEvent",
                                args: "{simpleDocumentMigration}.events.continueMigration",
                                reject: "jqUnit.assertDeepEq",
                                rejectArgs: ["There should be no more to migrate.", {
                                    "message": "No more documents to migrate."
                                },"{arguments}.0"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["There should be zero left", 0, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            }]
                        }
                    ]
                }, {
                    name: "Simple Document Migration: Bulk Migration",
                    tests: [
                        {
                            name: "Number of items to migrate",
                            sequenceGrade: "gpii.tests.migrations.sequenceGrade",
                            sequence: [{
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["5 items to migrate", 5, "{arguments}.0.docs.length"]
                            }, {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "fluid.promise.fireTransformEvent",
                                args: "{simpleBulkDocumentMigration}.events.continueBulkMigration",
                                reject: "jqUnit.assertDeepEq",
                                rejectArgs: ["There should be no more to migrate.", {
                                    "message": "No more documents to migrate."
                                },"{arguments}.0"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["There should be zero left", 0, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            }]
                        }
                    ]
                }]
            }
        }
    }
});

var beforeAfterTestDefaults = gpii.migrations.utils.createBeforeAfterTests(gpii.migrations.tests.simpleDocumentMigration());

fluid.test.runTests([
    "gpii.tests.migrations.simpleDocumentMigrationTest",
    beforeAfterTestDefaults
]);
