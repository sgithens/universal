/**
 GPII DB Data Store Tests

 Copyright 2016-2017 OCAD University

 Licensed under the New BSD license. You may not use this file except in
 compliance with this License.

 You may obtain a copy of the License at
 https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii  = fluid.registerNamespace("gpii");

require("gpii-couchdb-test-harness");
gpii.test.couchdb.loadTestingSupport();

require("gpii-migrations");

fluid.defaults("gpii.tests.migrations.environment", {
    gradeNames: ["gpii.test.couchdb.environment.base", "gpii.test.serverEnvironment"],
    databases: {
        gpii: {
            data: [
                "%gpii-migration/test/data/simpleMigrationDocuments.json",
                "%gpii-universal/testData/dbData/views.json"
                // "%gpii-db-operation/test/data/clientCredentials.json",
                // "%gpii-db-operation/test/data/gpiiAppInstallationAuthorizations.json",
                // "%gpii-db-operation/test/data/gpiiAppInstallationClients.json",
                // "%gpii-db-operation/test/data/gpiiCloudSafeCred.json",
                // "%gpii-db-operation/test/data/gpiiKeys.json",
                // "%gpii-db-operation/test/data/prefsSafes.json",
                // "%gpii-universal/testData/dbData/views.json"
            ]
        }
    },
    components: {
        testCaseHolder: {
            type: "gpii.tests.migrations.baseTestCaseHolder"
        }
    }
    // distributeOptions: {
        // source: "{that}.options.rawModules",
        // target: "{that > testCaseHolder}.options.rawModules"
    // },
    // mergePolicy: {
        // rawModules: "noexpand"
    // }
});

fluid.defaults("gpii.tests.migrations.baseTestCaseHolder", {
    gradeNames: ["gpii.test.couchdb.caseHolder"]
    // events: {
        // onResponse: null,
        // onError: null
    // }
    // components: {
    //     dbDataStore: {
    //         type: "gpii.dbOperation.dbDataStore",
    //         options: {
    //             dataSourceConfig: {
    //                 baseUrl: "http://localhost",
    //                 port: "{gpii.tests.dbDataStore.environment}.options.couch.port",
    //                 dbName: "gpii"
    //             }
    //         }
    //     }
    // }
});


// The test data is from %gpii-db-operation/test/data/*.json

/**
 * Test sequence:
 * Run mangoQuery for original number of items, verify correct.
 * Run mangoQuery for total number of documents, verify correct.
 * Run the migration.
 * Re-run both mangoQueries and verify number of items.
 * Check one of the migrated safes and verify it's structure
 */

fluid.defaults("gpii.tests.migrations.simpleDocumentMigration", {
    gradeNames: ["gpii.tests.migrations.environment"],
    rawModules: [{
        name: "Test findGpiiKey()",
        tests: [
            {
                name: "Very first test",
                sequence: [{
                    task: "console.log",
                    args: ["This is the very first migrations test"],
                    resolve: "jqUnit.assertDeepEq",
                    resolveArgs: ["This should be stuff", "Stuff2"] //, "{arguments}.0"]
                }]
            }
        ]
    }]
});

fluid.test.runTests([
    "gpii.tests.migrations.simpleDocumentMigration"
]);
