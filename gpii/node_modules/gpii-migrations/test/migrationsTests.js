/**
 GPII Migrations Tests

 Copyright 2016-2017 OCAD University

 Licensed under the New BSD license. You may not use this file except in
 compliance with this License.

 You may obtain a copy of the License at
 https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion"),
    gpii  = fluid.registerNamespace("gpii");

require("node-jqunit");

fluid.require("%gpii-universal");
gpii.loadTestingSupport();

require("gpii-migrations");

fluid.defaults("gpii.migrations.tests.simpleDocumentMigration", {
    gradeNames: ["gpii.migrations.couchDBmigration"],
    mangoQuery: {
        "selector": {
            "schemaVersion": {
                "$eq": "0.1"
            },
            "type": "prefsSafe"
        }
    },
    invokers: {
        "processDocument": {
            funcName: "gpii.migrations.tests.simpleDocumentMigration.processDocument",
            args: ["{arguments}.0"]
        }
    }
});

gpii.migrations.tests.simpleDocumentMigration.processDocument = function (doc) {
    doc.schemaVersion = "0.2";
    delete doc.password;
    return doc;
};

fluid.defaults("gpii.tests.migrations.caseHolder", {
    gradeNames: ["fluid.test.testCaseHolder"],
    events: {
        createPreferencesService: null
    },
    components: {
        simpleDocumentMigration: {
            type: "gpii.migrations.tests.simpleDocumentMigration",
            createOnEvent: "createPreferencesService",
            options: {
                couchDbUri: "http://localhost:25984/gpii",
                bulk: false
            }
        },
        simpleBulkDocumentMigration: {
            type: "gpii.migrations.tests.simpleDocumentMigration",
            createOnEvent: "createPreferencesService",
            options: {
                couchDbUri: "http://localhost:25984/gpii",
                bulk: true
            }
        },
        preferencesService: {
            type: "gpii.preferencesServer.preferencesService",
            createOnEvent: "createPreferencesService",
            options: {
                gradeNames: ["gpii.tests.dbOperation.dbDataStore.base"],
                components: {
                    dataStore: {
                        type: "gpii.dbOperation.dbDataStore",
                        options: {
                            dataSourceConfig: {
                                baseUrl: "http://localhost",
                                port: 25984,
                                dbName: "gpii"
                            }
                        }
                    }
                }
            }
        }
    }
});

fluid.defaults("gpii.tests.migrations.createPreferencesService", {
    gradeNames: ["fluid.test.sequenceElement"],
    sequence: [{
        func: "{caseHolder}.events.createPreferencesService.fire"
    }]
});

fluid.defaults("gpii.tests.migrations.sequenceGrade", {
    gradeNames: ["fluid.test.sequence"],
    sequenceElements: {
        startCouch: {
            gradeNames: "gpii.test.startCouchSequence",
            priority: "before:sequence"
        },
        createPreferencesService: {
            gradeNames: "gpii.tests.migrations.createPreferencesService",
            priority: "after:startCouch"
        },
        stopCouch: {
            gradeNames: "gpii.test.stopCouchSequence",
            priority: "after:sequence"
        }
    }
});

fluid.defaults("gpii.tests.migrations.environment", {
    gradeNames: ["gpii.test.couchdb.environment.base"],
    databases: {
        gpii: {
            data: [
                "%gpii-migrations/test/data/simpleMigrationDocuments.json",
                "%gpii-universal/testData/dbData/views.json"
            ]
        }
    },
    components: {
        caseHolder: {
            type: "gpii.tests.migrations.caseHolder"
        }
    }
});

// The test data is from %gpii-db-operation/test/data/*.json

/**
 * Test sequence:
 * Run mangoQuery for original number of items, verify correct.
 * Run mangoQuery for total number of documents, verify correct.
 * Run the migration.
 * Re-run both mangoQueries and verify number of items.
 * Check one of the migrated safes and verify it's structure
 */

fluid.defaults("gpii.tests.migrations.simpleDocumentMigrationTest", {
    gradeNames: ["gpii.tests.migrations.environment"],
    components: {
        caseHolder: {
            options: {
                modules: [{
                    name: "Simple Document Migration: Single Document at a Time",
                    tests: [
                        {
                            name: "Number of items to migrate",
                            sequenceGrade: "gpii.tests.migrations.sequenceGrade",
                            sequence: [{
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["5 items to migrate", 5, "{arguments}.0.docs.length"]
                            }, {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "fluid.promise.fireTransformEvent",
                                args: "{simpleDocumentMigration}.events.continueMigration",
                                reject: "jqUnit.assertDeepEq",
                                rejectArgs: ["There should be no more to migrate.", {
                                    "message": "No more documents to migrate."
                                },"{arguments}.0"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["There should be zero left", 0, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            }]
                        }
                    ]
                }, {
                    name: "Simple Document Migration: Bulk Migration",
                    tests: [
                        {
                            name: "Number of items to migrate",
                            sequenceGrade: "gpii.tests.migrations.sequenceGrade",
                            sequence: [{
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["5 items to migrate", 5, "{arguments}.0.docs.length"]
                            }, {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "fluid.promise.fireTransformEvent",
                                args: "{simpleBulkDocumentMigration}.events.continueBulkMigration",
                                reject: "jqUnit.assertDeepEq",
                                rejectArgs: ["There should be no more to migrate.", {
                                    "message": "No more documents to migrate."
                                },"{arguments}.0"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "schemaVersion": {
                                                "$eq": "0.1"
                                            },
                                            "type": "prefsSafe"
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["There should be zero left", 0, "{arguments}.0.docs.length"]
                            },
                            {
                                task: "gpii.migrations.mangoQuery",
                                args: [{
                                    mangoQuery: {
                                        "selector": {
                                            "type": { "$exists": true }
                                        }
                                    },
                                    couchDbUri: "http://localhost:25984/gpii"
                                }],
                                resolve: "jqUnit.assertEquals",
                                resolveArgs: ["7 docs total", 7, "{arguments}.0.docs.length"]
                            }]
                        }
                    ]
                }]
            }
        }
    }
});

fluid.test.runTests([
    "gpii.tests.migrations.simpleDocumentMigrationTest"
]);
